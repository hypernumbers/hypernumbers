-module(<%= @module_name  %>_SUITE).
-compile(export_all).

-include("ct.hrl").
-include("../../include/spriki.hrl").

-define(POST(Site, Path, Cell, Data), hn_post(Site, Path, Cell, Data)).
-define(GET(Site, Path, Cell), hn_get(Site, Path, Cell)).
-define(ASSERT_EQL(X, Y), assert_eql(X, Y)).

init_per_suite(Config) ->
    code:add_path("../../../../../ebin"),
    inets:start(),
    production_boot:start(),
    bits:clear_db(),
    Config.

end_per_suite(_Config) ->
    inets:stop(),
    production_boot:stop(),
    ok.

init_per_testcase(_TestCase, Config) ->
    Config.

end_per_testcase(_TestCase, _Config) ->
    ok.

all() ->
    [<%= @suite.collect { |t| t.name }.join(",\n") %>].

<% @suite.each { |testcase| %>
    <%= testcase.name %>() ->
        [{userdata, [{doc, ""}]}].

    <%= testcase.name %>(Config) when is_list(Config) ->
        ?POST("http://127.0.0.1:9000", 
              <%= testcase.path %>, 
              <%= testcase.cell %>, 
              <%= testcase.post_data %>),

        ?ASSERT_EQL("<%= testcase.expected_value %>", 
                    ?GET("http://127.0.0.1:9000", 
                         <%= testcase.path %>, 
                         <%= testcase.cell %>)).
<% } %>

%%% Helper functions.

hn_post(Site, Path, Cell, Data__) ->
    Url = Site ++ Path ++ atom_to_list(Cell),
    PostData = "action=create&value=" ++ Data__, % FIXME: CGI escape?
    Data = {Url, [], "text/plain", PostData},
    {ok, {{V, 200, R}, H, Body}} = http:request(post, Data, [], []).


hn_get(Site, Path, Cell) ->
    Url = Site ++ Path ++ atom_to_list(Cell),
    {ok, {{V, 200, R}, H, Body}} = http:request(get, {Url, []}, [], []),
    stdext:text2num(Body). %% Assume it's all numbers for now.


assert_eql(X, Y) when is_integer(X) andalso is_float(Y) ->
    X * 1.0 == Y;
assert_eql(X, Y) when is_float(X) andalso is_integer(Y) ->
    X == Y * 1.0;
assert_eql(X, Y) ->
    X == Y.
    
