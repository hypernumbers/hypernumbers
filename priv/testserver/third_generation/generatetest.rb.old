#!/usr/bin/env ruby -wKU
#-------------------------------------------------------------------------------
# Description: Takes a YAML file describing an Excel file (generated by 
#              readexcel.rb), and creates a test suite from it.
#
# Author:      Hasan Veldstra <hasan@hypernumbers.com>
# Created on:  18 Oct 2007
#-------------------------------------------------------------------------------

#TODO: Think about using the extra information available to help debug import errors.

require "yaml"

# Determines the type of a cell given its contents (formula & value as read by Excel).
def get_type(cell_data)
  return :formula if cell_data["formula"][0,1] == "=" && cell_data["formula"].length > 1
  return :number if cell_data["value"].kind_of?(Numeric)
  return :string if cell_data["value"].kind_of?(String)
  return :date if cell_data["value"].kind_of?(Time)
  return :boolean if (cell_data["value"].class == TrueClass || cell_data["value"].class == FalseClass)
end

# ====================================
# = Erlang code generation functions =
# ====================================
def erl_testcase(name, expected, got, output, doc = "")
<<-eos
#{name}(doc) -> ["#{doc}"];
#{name}(suite) -> [];
#{name}(Config) -> 
  #{output}
  test_util:expected(#{expected}, #{got}).
  
eos
end

def module_header(source_file, timestamp, modname)
<<-eos
% This module has been generated by generatetest.rb
% DO NOT EDIT MANUALLY.
%
% Source file: #{source_file}
% Generated on: #{timestamp}

-module(#{modname}).
-compile(export_all).
-include("test_server.hrl").


eos
end

def init_per_suite(source_file,mod_name)
<<-eos
init_per_suite(Config) ->
    code:add_patha("../../ebin"),
    production_boot:setup_paths(),
    Data = test_util:read_excel_file("/Win Excel 2007 (as 97)/#{source_file}"),
    %%io:format("in init_per_suite Data is ~p~n",[Data]),
    lists:merge([Config, [{#{mod_name}, Data}]]).
  
eos
end

def end_per_suite
<<-eos
end_per_suite(_Config) ->
    ok.
  
eos
end

def init_per_testcase
<<-eos
init_per_testcase(_TestCase, Config) -> Config.

eos
end

def end_per_testcase
<<-eos
end_per_testcase(_TestCase, _Config) -> ok.

eos
end

def read_from_excel_data(mod_name)
<<-eos
read_from_excel_data(Config, {Row,Col}) ->
    {value, Result} = lists:keysearch(#{mod_name}, 1, Config),
    Data = element(2, Result),
    Key={{row_index,Row},{col_index,Col}},
    {value, Result2} = lists:keysearch(Key, 1, Data),
    El=element(2, Result2),
    %%io:format("El is ~p~n",[El]),
    case El of
        {value, number, Number} -> {number,Number};
        {string,String}         -> {string,String};
        {formula,Formula}       -> {formula,Formula};
        {value,boolean,Boolean} -> {boolean,Boolean};
        {value,error,Error}     -> {error, Error};
        Other                   -> io:format("(in generatetest.rb - fix me Other is ~p~n",[Other])
    end.

eos
end

def all(test_cases)
<<-eos
all(doc) -> [""];
all(suite) -> 
    [#{test_cases}
    ].
  
eos
end

# ==============================================================
# = Main part: read YAML file, and generate test case from it. =
# ==============================================================

hash = File.open(ARGV[0]) { |f| YAML::load(f) }

modname = "#{File.basename(ARGV[0], ".yaml").downcase}_SUITE"
puts "modname is #{modname}"

File.open("#{modname}.erl", "w") do |suite|
  suite << module_header(hash["source-file"], Time.now.to_s, modname) +
           init_per_suite(hash["source-file"], modname) +
           end_per_suite() +
           init_per_testcase() +
           end_per_testcase() + 
           read_from_excel_data(modname)
  
  # Keep a list of names of generated test cases for all().
  test_names = []
  
  # Write test cases.
  hash.each do |col_cells|
    # col_cells will contain something like:
    # ["B", 
    #   { 5 => {"formula"=>"=UPPER(\"hello\")", "value"=>"HELLO"}, 
    #     3 => {"formula"=>"=1>0", "value"=>true},
    #     4 => {"formula"=>"zhopa", "value"=>"zhopa"}}]
    # Where "B" is, of course, the name of the column, and the elements in the
    # hash are { row_number => value } pairs.
    
    if col_cells[0] != "source-file" && col_cells[0] != "generated-on"
      col_cells[1].each do |row_data|
        # row_data data will contain something like:
        # [1, {"formula" => "=2 * 2.5", "value" => 5}]
        
        # This will give us a name like c15_test
        name = "#{col_cells[0].downcase}#{row_data[0]}_test"
        test_names << name
        # puts "get_type(row_data[1]) is #{get_type(row_data[1])}"
        expected, got_param, type =  case get_type(row_data[1])
                                     when :formula
                                       ["true", "\"#{row_data[1]["formula"]}\"", :formula]
                                     when :number
                                       ["true", "#{row_data[1]["value"]}", :number]
                                     when :boolean
                                       ["true", "#{row_data[1]["value"]}", :boolean]
                                     when :string
                                       ["true", "\"#{row_data[1]["value"]}\"", :string]
                                     when :date
                                       ["true", "\"#{row_data[1]["value"]}\"", :date]
                                     else
                                       ["\"not tested (type not supported by generatetest.rb yet)\"", 0, :not_supported]
                                     end

        got = "test_util:excel_equal({#{type.to_s},#{got_param}}, " + 
              "read_from_excel_data(Config,{#{row_data[0]-1},#{col_cells[0][-1]-65}}))"
        
        output = "io:format(\"Expected : ~p~nGot      : ~p~n\"," + 
          "[#{got_param},read_from_excel_data(Config,{#{row_data[0]-1},#{col_cells[0][-1]-65}})]),"
        
        suite << erl_testcase(name, expected, got, output)
      end
    end
  end
  
  # Three spaces after the line break, so that the output is formatted nicely.
  suite << all(test_names.join(",\n   ")) 
end