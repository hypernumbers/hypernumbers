#! /bin/bash

NODE=arrian
HOST=localhost
RELNAME=hypernumbers
SASL_CONF_FILE=sasl_dev_conf.config
COOKIE=abc

# check if we are running under cywgin
ISCYGWIN=`uname -a | cut -f 1 -d " "`
if [ $ISCYGWIN = "CYGWIN_NT-6.0" ]
    then
        ROOT=`pwd`
        ROOT2="c:/"`echo $ROOT | cut -d "/" -f 4-`
   else
        ROOT2=`dirname $0`
fi
MODE=""
RELOAD="-run reloader start"

LOG_DIR=$ROOT2/logs
CONFIG=$ROOT2/priv/hypernumbers.conf
MNESIA_DIR=$ROOT2/database/$NODE
REL_DIR=$ROOT2/ebin/$RELNAME
SASL_DIR=$ROOT2/priv/$SASL_CONF_FILE

## Create mnesia and log directories
## and config file if they dont exist
[ -d $LOG_DIR ]        || mkdir -p $LOG_DIR
[ -d $LOG_DIR/error ]  || mkdir -p $LOG_DIR/error
[ -d $MNESIA_DIR ]     || mkdir -p $MNESIA_DIR
[ -f $CONFIG ]         || cp $ROOT/priv/hypernumbers.conf.default $CONFIG

function build
{
    cd $ROOT2
    if [ $# -lt 1 ] 
    then
        echo "==============================="
        echo "      COMPILING STARLING      "
        echo "==============================="
        cd ./lib/starling/
        rake
        cd ../../
        echo "==============================="
        echo " GENERATING LEXERS AND PARSERS "
        echo "==============================="
        cd ./priv/muin/
        erlc generate.erl
        erl -noshell -s generate gen -s init stop
        cd ../../
    fi
    
    echo "==============================="
    echo "       COMPILING COMPILER      "
    echo "==============================="
    erlc -o ebin src/compile_code.erl
    echo "==============================="
    echo "      GENERATING MS_UTIL       "
    echo "==============================="
    HN_DIR="lib/hypernumbers-1.0"
    erlc -o $HN_DIR/ebin -I $HN_DIR/include priv/ms_util/make_ms_util.erl
    erl -pa $HN_DIR/ebin -noshell -s make_ms_util make -s init stop
    mv ms_util2.erl $HN_DIR/src
    echo "==============================="
    echo "            BUILDING           "
    echo "==============================="
    cd ebin
    erl -pa ebin -noshell -s compile_code -s init stop
}

function start
{
    erl $MODE \
        $RELOAD \
        -setcookie $COOKIE \
        -sname $NODE@$HOST \
        -boot $REL_DIR \
        -config $SASL_DIR \
        -hn_config $CONFIG \
        -hn_log $LOG_DIR \
        -mnesia dir "\"$MNESIA_DIR\""
}

function test
{
    if [ $# -lt 1 ] 
    then
        echo "hypernumbers test 1a - to run specific test"
        echo "hypernumbers test 1  - to run specific X series"
        exit
    fi

    TESTS=$(find $ROOT2/tests/ -maxdepth 1 -name "*$1*" \
        | grep -v .svn \
        | grep -v common_test-1.3.0 \
        | grep -v test_server-3.2.0 \
        | grep -v excel_files \
        | grep -v test_server-3.2.0)

    $ROOT2/tests/common_test-1.3.0/priv/bin/run_test \
        -noshell \
        -setcookie $COOKIE \
        -sname $NODE@$HOST \
        -boot $REL_DIR \
        -config $SASL_DIR \
        -hn_config $CONFIG \
        -hn_log $LOG_DIR \
        -logdir $LOG_DIR \
        -mnesia dir "\"$MNESIA_DIR\"" \
        -dir $TESTS
}

case $1 in 
    start) start;;
    build) build $2;;
    test)  test $2;;
esac