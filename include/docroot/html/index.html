<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
        
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>Hypernumbers</title>

    <script type="text/javascript" src="/js/jquery.js"></script>
	<script type="text/javascript" src="/js/jquery.contextmenu.js"></script>
	<script type="text/javascript" src="/js/jquery.simplemodal.js"></script>
	<script type="text/javascript" src="/js/ajaxfileupload.js"></script>
	<script type="text/javascript" src="/js/jquery.bgiframe.min.js"></script>
	<script type="text/javascript" src="/js/jquery.clickmenu.js"></script>
	<script type="text/javascript" src="/js/jquery.spreadsheet.js"></script>
	<script type="text/javascript" src="/js/jquery.textbox.js"></script>
	<script type="text/javascript" src="/js/swfobject.js"></script>
	<script type="text/javascript" src="/js/socket.js"></script>

	<style type="text/css">
		@import "/css/base.css";
		@import "/css/modal.css";
		@import "/css/clickmenu.css";
		@import "/css/jquery.spreadsheet.css";
        @import "/css/jquery.textbox.css";
	</style>

	<script type="text/javascript">
    
        var formulae = new Array();
        var css_attrs = ["font-style","font-weight","text-align","text-decoration"];
        
        var handle_attr = function(type,ref,name,value)
        {
            if( jQuery.inArray(name, css_attrs) != -1 )
                $("#hn").spreadsheet("setStyle",ref,name,value);
            
            else if(name == "formula") formulae[ref] = value;  
            else if(name == "height")  $("#hn").spreadsheet("setHeight",ref,value);
            else if(name == "width")   $("#hn").spreadsheet("setWidth",ref,value);
            else if(name == "name")    $("#hn").spreadsheet("addName",ref,value);
            else if(name == "value")   $("#hn").spreadsheet("setValue",ref,value);    
        }
    
		$(function()
		{
            var range = "a1:z50";
            
		    var url = document.location.href;
		    var so = new SWFObject("/swf/JsSocket.swf", "mymovie", "470", "200", "8", "#FFFFFF");
            
		    so.addParam("allowScriptAccess", "always");
            so.write("flashcontent");
            
			// Import SpreadSheet
			$("#m_import").click( function()
			{
				$("#filemenu ul").toggle();
				var x = $("#import").modal();
				$("#Filedata").change(function()
				{
					$.ajaxFileUpload
					({
						url:'?import',
						secureuri:false,
						datatype: "json",
						fileElementId:'Filedata'
					})
					x.close();
				});
			});
			
			$.get(url+"?pages&format=xml", function(data)
			{
                var add = function(root,dir,path)
				{
					var list = $("<ul />").appendTo(root);
					
					$(dir).children().each(function()
					{
						var npath = $(this).attr("path");
						npath = (npath == "/") ? "" : npath;
						var parent = $("<li><a href=\""+path+npath+"/\">/"+npath+"</a></li>").appendTo(list);
						if($(this).children().size() > 0)
					       add(parent,this,path+npath+"/");
					});
				}
		
				add($("#browse"),$(data),"");
				$.fn.clickMenu.setDefaults({arrowSrc:"/img/arrow.png"});
				$("#menu").clickMenu();
			});
            
			var defaults =
            {
                fullscreen : true,
                range      : range,
                fmargin    : 24,
                cellChange  : function(x,y,val)
                {
                    $.post(url+$.fn.to_b26(x+1)+y+"?attr",
                        "<create><value>"+val+"</value></create>",null,"xml");
                },
                cellSelect : function(x,y,el)
                {
                    var f = formulae[($.fn.to_b26(x+1)+y)];
                    el.val( (typeof f != "undefined") ? "="+f : "");
                },
                colResize : function(col,width)
                {
                    $.post(url+$.fn.to_b26(col)+"?attr",
                        "<create><width>"+width+"</width></create>",null,"xml");
                },
                rowResize : function(row,height)
                {
                    $.post(url+row+"?attr",
                        "<create><height>"+height+"</height></create>",null,"xml");
                },
                cssChange : function(el,attr,val)
                {
                    var ref = $.fn.cell_index(el);
                    $.post(url+$.fn.to_b26((ref[0]+1))+(ref[1]+1)+"?attr",
                        "<create><"+attr+">"+val+"</"+attr+"></create>",null,"xml");
                },
                setName : function(range,name)
                {
                    $.post(url+range+"?attr",
                        "<create><name>"+name+"</name></create>",null,"xml");
                }
            };
            
			$("#hn").spreadsheet(defaults);
            
			$.getJSON(url+"?attr&format=json", function(data) 
			{
				$(data[1]).each(function(y)
				{
                    var t = this[1];
                    handle_attr(t[0].type,t[1].ref,t[2][0],t[2][1][0]);
				});
			});
            
			$('#hn tr > td > div').contextMenu('myMenu1',
            {
				bindings:
                {
					'hnumber': function(t)
                    {
                        copy(document.getElementById("texttocopy"));
					}
				},
				menuStyle:
                {
					width: '150px'
				},
				itemStyle:
                {
					font: '8px',
					border: 'none',
					padding: '3px'
				},
				itemHoverStyle:
                {
					background: '#EEE',
					border: 'none'
				}
		    });
		});

    </script>

</head>

<body>

    <div id="header"><img src="/img/logo.jpg" alt="header" /></div>

		<ul id="menu">
			<li>File
				<ul><li id="browse">Browse</li>
					<li class="sep">&nbsp;</li>
					<li id="m_import">Import SpreadSheet</li></ul>
			</li>
			<li>HyperNumbers
				<ul><li>Incoming Links </li>
					<li>Ougoing Links </li>
				</ul>
			</li>
			<li>Help
				<ul>
					<li>About...</li>
				</ul>
			</li>
		</ul>
		
		<div id="hn"></div>

		<div id="footer">
			<div id="connection">
				<img src="/img/cross.png" alt="Socket Connection" /> 
				<span>disconnected</span>
			</div>
		</div>

		<div id="flashcontent">
				This text is replaced by the Flash movie.
		</div>

		<textarea id="texttocopy"></textarea>

		<div class="contextMenu" id="myMenu1">
			<ul>
				<li id="hnumber">Copy as Hypernumber</li>
			</ul>
		</div>

		<div id="import">
			<h2>Import File</h2>
			<hr />
			<p>Import a file to this websheet (currently xls files are supported)</p>
			<input type="file" name="Filedata" id="Filedata" value="Upload Spreadsheet" />
		</div>


	</body>

</html>