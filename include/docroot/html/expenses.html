<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
        
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>Hypernumbers Expenses System</title>

	<style type="text/css">
        *
        {
            margin: 0px;
            padding:0px;
            font: 11px sans-serif;
        }

        html,body { height:100%; background: #f0f8ff; }
       
	    #wrapper
	    { 
	        height:100%;
	        padding:10px;
	        width:650px; 
	        margin:0px auto;
	        background:#FFF;
	        font: 11px sans-serif; 
	        border-left:1px solid #999;
	        border-right:1px solid #999; 
	    }
	    
	    label { display:block; margin:5px; vertical-align:top; }
	    #details label span { display:block; width:140px; float:left; }
	    h1 { font: 22px sans-serif; margin-bottom:10px; }
        h2 { font: 16px sans-serif; }
        hr { border-top:1px solid #EEE; margin-bottom:10px; }
        p { margin:6px 0px 6px 0px; }
        #head { padding: 10px; background:#eee; margin-bottom:10px; }
        #head h1 { display:inline; font-weight:bold;} 
	</style>
	
    <script type="text/javascript" src="/js/jquery.js"></script>
    
    <script type="text/javascript">
    
        var post_vars = new Array();
        var path = getPath();

        function getPath()
	{
            console.log("in getPath **starts**");
 	    page=document.location.pathname;
	    segments=page.split("/");
            len=segments.length;
            path="";
            for (i=1; i < len-1; i++)
            {
              path=path+"/"+segments[i];
            };
            path=path+"/";
            console.log(path);
            console.log("**ends**");
            return path;
        }
    
        function parseRef(cell)
        {
            return [
                ((cell.match(/[a-z]+/i)[0]).charCodeAt(0)-64),
                 parseInt(cell.match(/[0-9]+/)[0])];
        }
        
        function handleElement(root,params)
        {
            console.log("in handleElement **starts**");
            console.log(root);
            console.log(params);
            console.log("**ends**");
            if(params[0] == "select")
            {
                if ((params[2][0] == "/") || (params[2][0] == "."))
                {
                    get_path=params[2];
                }
                else
                {
                    get_path=root+params[2];
                }
                console.log(get_path);
                var select = $("<select />").appendTo($(params[1]));   
                $.get(get_path+"?attr",function(data) 
                {
                    $(data).find("ref").each(function()
                    {
                        if($(this).find("rawvalue").size() > 0)
                        {
                            select.append($("<option>"+
                                $(this).find("rawvalue > string").text()+"</option>"));
                        }
                    });
                });
                post_vars.push({type:"select",input:select,destination:params[3]});
            }
            else if(params[0] == "radio")
            {
                $.get(root+params[2]+"?attr",function(data) 
                {
                    var inputs = new Array();
                    $(data).find("ref").each(function()
                    {
                        if($(this).find("rawvalue").size() > 0)
                        {
                            var n = $(this).find("rawvalue > string").text();
                            var el = $("<input type='radio' name="+params[4]+" value='"+n+"' \>");
                            inputs.push(el);
                            $(params[1]).append(el).append($("<span> "+n+"</span>"));
                        }
                    });
                    post_vars.push({type:"radio",input:inputs,destination:params[3]}); 
                });
            }   
            else if(params[0] == "textinput")
            {
                var el = $("<input type=\"text\" />");
                $(params[1]).append($("<label><span>" + params[2]
                    + "</span></label>").append(el));    
                post_vars.push({type:"text",input:el,destination:params[3]});   
            }
            else if(params[0] == "textarea")
            {
                var el = $("<textarea></textarea>");
                $(params[1]).append($("<label><span>" + params[2]
                    + "</span><br /></label>").append(el));
                post_vars.push({type:"textarea",input:el,destination:params[3]});  
            }
            else if(params[0] == "text")
            {
                $(params[1]).text(params[2]);      
            }
        }
    
        function loadForm(root,range)
        {
        console.log("in loadForm **starts**");
        console.log(root);
        console.log("**ends**");
            $.get(root+range+"?attr",function(data)   
            {
                var reflist = new Array();

                $(data).find("ref").each(function()
                
                {
                    if($(this).find("rawvalue").size() > 0)
                    {
                        var ref = parseRef($(this).attr("ref"));                        
                         if(typeof reflist[ref[1]] == "undefined")
                            reflist[ref[1]] = new Array();
                            
                        reflist[ref[1]][ref[0]-1] = $(this);
                    }
                });
                $.each(reflist,function(i)
                {
                    if(this.length>0)
                    {
                        var params = new Array();
                                                    
                        for(i=0; i < this.length; i++) 
                        {
                            params.push(this[i].find("string").text());
                        }
                        handleElement(root,params);
                    }
                });
            });
        }
        
        function loadRange(cfg)
        {
            $.get(cfg+"a1?attr",function(data)
            {
                var range = $(data).find("rawvalue > string").text();
    
                loadForm(cfg,range);
            });
        }
    
        $(function()
        {
            loadRange("/data/");
            $("input[type='submit']").click(function()
            {
                post_vars.sort(function(a,b)
                {
                    return a.destination.charCodeAt(0) < 
                        b.destination.charCodeAt(0) ? -1 : 1;
                });
                
                var str = "<create>";

                for(i=0; i< post_vars.length; i++)
                {
                    var getChecked = function(arr)
                    {
                        for(x=0; x< arr.length; x++)
                        {
                            if((arr[x])[0].checked)
                                return arr[x].attr('rawvalue');
                        }
                    }
                
                    var val = (post_vars[i].type != "radio") 
                        ? post_vars[i].input.val()
                        : getChecked(post_vars[i].input);
                        
                    str += "<formula><![CDATA["+val+"]]></formula>";
                }
                str += "</create>";
                console.log("checking post string in loadRange **starts**");
                console.log(str);
                console.log("**ends**");
                
                $.post("/?attr&lastrow",str,null,"xml");                
            });
        });
    </script>
    
</head>
<body><div id="wrapper">

    <img src="/img/logo.jpg"/>
    <div id="head"><h1></h1></div>

    <h1 id="header"></h1>
    
    <div id="details"></div>
    <br />
    
    <p><span id="who_label"></span>
    <span id="who"></span></p>
    
    <div id="detailstext"></div>
    <br />
    <input type="submit" value="submit" />
    
</div></body>
</html>
